<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  </head>
  <body>
    <!-- Landing Page -->
    <div id="landing" style="
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      color: white;
      font-family: Arial, sans-serif;
    ">
      <h1 style="margin-bottom: 30px; text-align: center;">AR Experience</h1>
      <button id="startScan" style="
        padding: 15px 30px;
        font-size: 18px;
        background: #4CAF50;
        color: white;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      ">Start Scan</button>
    </div>

    <!-- AR Scene -->
    <a-scene
      mindar-image="imageTargetSrc: ./targets.mind;"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
      style="display: none;"
      id="arScene"
    >
      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
      
      <a-assets>
        <video id="vid1" playsinline webkit-playsinline preload="auto" muted>
          <source src="./testing.MP4" type="video/mp4">
          <source src="./testing.webm" type="video/webm">
        </video>
      </a-assets>

      <a-entity mindar-image-target="targetIndex: 0" id="target1">
        <a-video id="videoPlane" src="#vid1" width="1" height="0.75" position="0 0 0" rotation="0 0 0" material="shader: flat; transparent: true; side: double"></a-video>
      </a-entity>
    </a-scene>

    <!-- Learn More Button -->
    <button id="learnMoreBtn" style="
      position: fixed;
      bottom: 50px;
      left: 50%;
      transform: translateX(-50%);
      padding: 15px 30px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      display: none;
      z-index: 1001;
      font-size: 16px;
      font-weight: bold;
    ">Learn More</button>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const landing = document.getElementById('landing');
        const arScene = document.getElementById('arScene');
        const startScanBtn = document.getElementById('startScan');
        const learnMoreBtn = document.getElementById('learnMoreBtn');

        startScanBtn.onclick = function() {
          console.log('Start scan clicked');
          navigator.mediaDevices.getUserMedia({
            video: {
              facingMode: { ideal: 'environment' },
              width: { ideal: 1920 },
              height: { ideal: 1080 }
            }
          }).then(stream => {
            const track = stream.getVideoTracks()[0];
            const settings = track.getSettings ? track.getSettings() : {};
            console.log('Camera settings:', settings);
            // Stop preview stream; MindAR will open the camera itself
            stream.getTracks().forEach(t => t.stop());
            landing.style.display = 'none';
            arScene.style.display = 'block';
            // Prime video to unlock autoplay on iOS
            try {
              video1.setAttribute('playsinline', 'true');
              video1.setAttribute('webkit-playsinline', 'true');
              video1.muted = true;
              video1.load();
              video1.play().then(() => {
                video1.pause();
                video1.currentTime = 0;
                console.log('Video primed');
              }).catch(err => console.log('Prime failed:', err));
            } catch (e) { console.log('Prime exception:', e); }
          }).catch(err => {
            console.error('getUserMedia failed:', err);
            // Still proceed to show scene; user may grant inside browser UI
            landing.style.display = 'none';
            arScene.style.display = 'block';
          });
        };

        // Listen for AR initialization
        arScene.addEventListener('mindARImageTrackingInitialized', () => {
          console.log('MindAR initialized successfully');
        });

        arScene.addEventListener('mindARImageTrackingError', (error) => {
          console.error('MindAR initialization error:', error);
        });

        const target1 = document.querySelector('#target1');
        const video1 = document.querySelector('#vid1');
        const videoPlane = document.querySelector('#videoPlane');
        // stop immediately on loss

        target1.addEventListener('targetFound', () => {
          console.log('Target found');
          console.log('Video element:', video1);
          console.log('Video readyState:', video1.readyState);
          console.log('Video duration:', video1.duration);
          if (targetLostTimer) {
            clearTimeout(targetLostTimer);
            targetLostTimer = null;
          }
          // ensure content stays visible when re-found
          target1.object3D.visible = true;
          if (videoPlane) videoPlane.object3D.visible = true;
          video1.play().then(() => {
            console.log('Video started playing');
          }).catch((error) => {
            console.error('Video play failed:', error);
            // If autoplay fails, wait for user click
            document.addEventListener('click', function playVideo() {
              video1.play();
              document.removeEventListener('click', playVideo);
            }, { once: true });
          });
        });
        
        target1.addEventListener('targetLost', () => {
          console.log('Target lost - will pause after grace');
          if (targetLostTimer) clearTimeout(targetLostTimer);
          // keep visible during grace period
          target1.object3D.visible = true;
          targetLostTimer = setTimeout(() => {
            console.log('Target still lost - pausing video');
            video1.pause();
            // finally hide after grace if still not found
            target1.object3D.visible = false;
            if (videoPlane) videoPlane.object3D.visible = false;
          }, LOST_GRACE_MS);
        });

        video1.addEventListener('ended', () => {
          learnMoreBtn.style.display = 'block';
        });

        learnMoreBtn.onclick = function() {
          window.location.href = 'https://www.cityofdreamsmacau.com/tc/house-of-dancing-water';
        };
      });
    </script>
  </body>
</html>
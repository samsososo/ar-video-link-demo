<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  </head>
  <body>
    <!-- Landing Page -->
    <div
      id="landing"
      style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        color: white;
        font-family: Arial, sans-serif;
      "
    >
      <h1 style="margin-bottom: 30px; text-align: center">AR Experience</h1>
      <button
        id="startScan"
        style="
          padding: 15px 30px;
          font-size: 18px;
          background: #4caf50;
          color: white;
          border: none;
          border-radius: 25px;
          cursor: pointer;
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        "
      >
        Start Scan
      </button>
    </div>

    <!-- AR Scene -->
    <a-scene
      mindar-image="imageTargetSrc: ./targets.mind;"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
      style="display: none"
      id="arScene"
    >
      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <a-assets>
        <!-- Preload all videos from CDN -->
        <video
          id="vid_AaniJean"
          playsinline
          webkit-playsinline
          preload="auto"
          crossorigin="anonymous"
        >
          <source
            src="https://d392t2kbzfe6yu.cloudfront.net/config/testing/AaniJean.mp4"
            type="video/mp4"
          />
        </video>
        <video
          id="vid_Chandelier"
          playsinline
          webkit-playsinline
          preload="auto"
          crossorigin="anonymous"
        >
          <source
            src="https://d392t2kbzfe6yu.cloudfront.net/config/testing/Chandelier.mp4"
            type="video/mp4"
          />
        </video>
        <video
          id="vid_DarkQueen"
          playsinline
          webkit-playsinline
          preload="auto"
          crossorigin="anonymous"
        >
          <source
            src="https://d392t2kbzfe6yu.cloudfront.net/config/testing/DarkQueen.mp4"
            type="video/mp4"
          />
        </video>
        <video
          id="vid_Encounter"
          playsinline
          webkit-playsinline
          preload="auto"
          crossorigin="anonymous"
        >
          <source
            src="https://d392t2kbzfe6yu.cloudfront.net/config/testing/Encounter.mp4"
            type="video/mp4"
          />
        </video>
        <video
          id="vid_GoldBoat"
          playsinline
          webkit-playsinline
          preload="auto"
          crossorigin="anonymous"
        >
          <source
            src="https://d392t2kbzfe6yu.cloudfront.net/config/testing/GoldBoat.mp4"
            type="video/mp4"
          />
        </video>
        <video
          id="vid_MagicGarden"
          playsinline
          webkit-playsinline
          preload="auto"
          crossorigin="anonymous"
        >
          <source
            src="https://d392t2kbzfe6yu.cloudfront.net/config/testing/MagicGarden.mp4"
            type="video/mp4"
          />
        </video>
        <video
          id="vid_Motobike"
          playsinline
          webkit-playsinline
          preload="auto"
          crossorigin="anonymous"
        >
          <source
            src="https://d392t2kbzfe6yu.cloudfront.net/config/testing/Motobike.mp4"
            type="video/mp4"
          />
        </video>
        <video
          id="vid_Reunion"
          playsinline
          webkit-playsinline
          preload="auto"
          crossorigin="anonymous"
        >
          <source
            src="https://d392t2kbzfe6yu.cloudfront.net/config/testing/Reunion.mp4"
            type="video/mp4"
          />
        </video>
        <video
          id="vid_Torture"
          playsinline
          webkit-playsinline
          preload="auto"
          crossorigin="anonymous"
        >
          <source
            src="https://d392t2kbzfe6yu.cloudfront.net/config/testing/Torture.mp4"
            type="video/mp4"
          />
        </video>
        <video
          id="vid_War"
          playsinline
          webkit-playsinline
          preload="auto"
          crossorigin="anonymous"
        >
          <source
            src="https://d392t2kbzfe6yu.cloudfront.net/config/testing/War.mp4"
            type="video/mp4"
          />
        </video>
      </a-assets>

      <!-- One entity per target index inside a combined targets.mind -->
      <a-entity mindar-image-target="targetIndex: 0" id="target_AaniJean">
        <a-video
          id="plane_AaniJean"
          src="#vid_AaniJean"
          width="1"
          height="0.5625"
          position="0 0 0"
          rotation="0 0 0"
          material="shader: flat; transparent: true; side: double"
        ></a-video>
      </a-entity>
      <a-entity mindar-image-target="targetIndex: 1" id="target_Chandelier">
        <a-video
          id="plane_Chandelier"
          src="#vid_Chandelier"
          width="1"
          height="0.5625"
          position="0 0 0"
          rotation="0 0 0"
          material="shader: flat; transparent: true; side: double"
        ></a-video>
      </a-entity>
      <a-entity mindar-image-target="targetIndex: 2" id="target_DarkQueen">
        <a-video
          id="plane_DarkQueen"
          src="#vid_DarkQueen"
          width="1"
          height="0.5625"
          position="0 0 0"
          rotation="0 0 0"
          material="shader: flat; transparent: true; side: double"
        ></a-video>
      </a-entity>
      <a-entity mindar-image-target="targetIndex: 3" id="target_Encounter">
        <a-video
          id="plane_Encounter"
          src="#vid_Encounter"
          width="1"
          height="0.5625"
          position="0 0 0"
          rotation="0 0 0"
          material="shader: flat; transparent: true; side: double"
        ></a-video>
      </a-entity>
      <a-entity mindar-image-target="targetIndex: 4" id="target_GoldBoat">
        <a-video
          id="plane_GoldBoat"
          src="#vid_GoldBoat"
          width="1"
          height="0.5625"
          position="0 0 0"
          rotation="0 0 0"
          material="shader: flat; transparent: true; side: double"
        ></a-video>
      </a-entity>
      <a-entity mindar-image-target="targetIndex: 5" id="target_MagicGarden">
        <a-video
          id="plane_MagicGarden"
          src="#vid_MagicGarden"
          width="1"
          height="0.5625"
          position="0 0 0"
          rotation="0 0 0"
          material="shader: flat; transparent: true; side: double"
        ></a-video>
      </a-entity>
      <a-entity mindar-image-target="targetIndex: 6" id="target_Motobike">
        <a-video
          id="plane_Motobike"
          src="#vid_Motobike"
          width="1"
          height="0.5625"
          position="0 0 0"
          rotation="0 0 0"
          material="shader: flat; transparent: true; side: double"
        ></a-video>
      </a-entity>
      <a-entity mindar-image-target="targetIndex: 7" id="target_Reunion">
        <a-video
          id="plane_Reunion"
          src="#vid_Reunion"
          width="1"
          height="0.5625"
          position="0 0 0"
          rotation="0 0 0"
          material="shader: flat; transparent: true; side: double"
        ></a-video>
      </a-entity>
      <a-entity mindar-image-target="targetIndex: 8" id="target_Torture">
        <a-video
          id="plane_Torture"
          src="#vid_Torture"
          width="1"
          height="0.5625"
          position="0 0 0"
          rotation="0 0 0"
          material="shader: flat; transparent: true; side: double"
        ></a-video>
      </a-entity>
      <a-entity mindar-image-target="targetIndex: 9" id="target_War">
        <a-video
          id="plane_War"
          src="#vid_War"
          width="1"
          height="0.5625"
          position="0 0 0"
          rotation="0 0 0"
          material="shader: flat; transparent: true; side: double"
        ></a-video>
      </a-entity>
    </a-scene>

    <!-- Learn More Button -->
    <button
      id="learnMoreBtn"
      style="
        position: fixed;
        bottom: 50px;
        left: 50%;
        transform: translateX(-50%);
        padding: 15px 30px;
        background: #4caf50;
        color: white;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        display: none;
        z-index: 1001;
        font-size: 16px;
        font-weight: bold;
      "
    >
      Learn More
    </button>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const LOST_GRACE_MS = 600; // pause shortly after lost to avoid flicker
        const landing = document.getElementById("landing");
        const arScene = document.getElementById("arScene");
        const startScanBtn = document.getElementById("startScan");
        const learnMoreBtn = document.getElementById("learnMoreBtn");

        // Optional: allow overriding the target file via ?src=targets_X.mind
        const urlParams = new URLSearchParams(window.location.search);
        const overrideSrc = urlParams.get("src");
        if (overrideSrc) {
          arScene.setAttribute(
            "mindar-image",
            `imageTargetSrc: ./${overrideSrc};`
          );
          // If loading a single-target .mind via ?src=targets_X.mind, map that X to targetIndex:0
          // and hide other targets to ensure correct video plays.
          try {
            const nameFromSrc = overrideSrc
              .replace(/^.*\/(?:)?/, "") // strip path
              .replace(/^targets_/, "")
              .replace(/\.mind$/i, "");
            const targetIds = [
              "AaniJean",
              "Chandelier",
              "DarkQueen",
              "Encounter",
              "GoldBoat",
              "MagicGarden",
              "Motobike",
              "Reunion",
              "Torture",
              "War",
            ];
            // Set all targets invisible initially
            targetIds.forEach((n) => {
              const el = document.getElementById(`target_${n}`);
              if (el) el.setAttribute("visible", "false");
            });
            const matched = document.getElementById(`target_${nameFromSrc}`);
            if (matched) {
              // Ensure this one is index 0 so single-target .mind works
              matched.setAttribute("mindar-image-target", "targetIndex: 0");
              matched.setAttribute("visible", "true");
            }
          } catch (_) {}
        } else {
          // Auto-detect a usable targets file to avoid infinite loading when targets.mind is missing
          (async () => {
            const candidates = [
              "targets.mind",
              "targets_AaniJean.mind",
              "targets_Chandelier.mind",
              "targets_DarkQueen.mind",
              "targets_Encounter.mind",
              "targets_GoldBoat.mind",
              "targets_MagicGarden.mind",
              "targets_Motobike.mind",
              "targets_Reunion.mind",
              "targets_Torture.mind",
              "targets_War.mind",
            ];
            for (const file of candidates) {
              try {
                const res = await fetch(`./${file}`, { method: "HEAD" });
                if (res.ok) {
                  arScene.setAttribute(
                    "mindar-image",
                    `imageTargetSrc: ./${file};`
                  );
                  // If it's a single-target file, align that target to index 0 and hide others
                  if (file !== "targets.mind") {
                    const nameFromSrc = file
                      .replace(/^.*\/(?:)?/, "")
                      .replace(/^targets_/, "")
                      .replace(/\.mind$/i, "");
                    const targetIds = [
                      "AaniJean",
                      "Chandelier",
                      "DarkQueen",
                      "Encounter",
                      "GoldBoat",
                      "MagicGarden",
                      "Motobike",
                      "Reunion",
                      "Torture",
                      "War",
                    ];
                    targetIds.forEach((n) => {
                      const el = document.getElementById(`target_${n}`);
                      if (el)
                        el.setAttribute(
                          "visible",
                          n === nameFromSrc ? "true" : "false"
                        );
                    });
                    const matched = document.getElementById(
                      `target_${nameFromSrc}`
                    );
                    if (matched)
                      matched.setAttribute(
                        "mindar-image-target",
                        "targetIndex: 0"
                      );
                  }
                  break;
                }
              } catch (_) {}
            }
          })();
        }

        startScanBtn.onclick = function () {
          console.log("Start scan clicked");
          navigator.mediaDevices
            .getUserMedia({
              video: {
                facingMode: { ideal: "environment" },
                width: { ideal: 1920 },
                height: { ideal: 1080 },
              },
            })
            .then((stream) => {
              const track = stream.getVideoTracks()[0];
              const settings = track.getSettings ? track.getSettings() : {};
              console.log("Camera settings:", settings);
              // Stop preview stream; MindAR will open the camera itself
              stream.getTracks().forEach((t) => t.stop());
              landing.style.display = "none";
              arScene.style.display = "block";
              // Preload videos so they are ready; do not force muted/autoplay to allow sound
              const videos = Array.from(
                document.querySelectorAll("a-assets video")
              );
              videos.forEach((v) => {
                try {
                  v.setAttribute("playsinline", "true");
                  v.setAttribute("webkit-playsinline", "true");
                  v.load();
                  // Do not auto-play here to avoid requiring mute; play will be triggered on targetFound
                } catch (_) {}
              });
            })
            .catch((err) => {
              console.error("getUserMedia failed:", err);
              // Still proceed to show scene; user may grant inside browser UI
              landing.style.display = "none";
              arScene.style.display = "block";
            });
        };

        // Listen for AR initialization
        arScene.addEventListener("mindARImageTrackingInitialized", () => {
          console.log("MindAR initialized successfully");
        });

        arScene.addEventListener("mindARImageTrackingError", (error) => {
          console.error("MindAR initialization error:", error);
        });

        // Mapping from target ids to their video and plane elements
        const targetIds = [
          "AaniJean",
          "Chandelier",
          "DarkQueen",
          "Encounter",
          "GoldBoat",
          "MagicGarden",
          "Motobike",
          "Reunion",
          "Torture",
          "War",
        ];
        const targets = {};
        const targetLostTimers = {};
        let currentlyPlayingId = null;

        targetIds.forEach((name) => {
          const targetEl = document.getElementById(`target_${name}`);
          const videoEl = document.getElementById(`vid_${name}`);
          const planeEl = document.getElementById(`plane_${name}`);
          if (!targetEl || !videoEl || !planeEl) return;
          targets[name] = { targetEl, videoEl, planeEl };

          targetEl.addEventListener("targetFound", () => {
            // cancel any pending lost timer for this target
            if (targetLostTimers[name]) {
              clearTimeout(targetLostTimers[name]);
              targetLostTimers[name] = null;
            }
            // hide other planes and pause other videos
            Object.entries(targets).forEach(
              ([otherName, { targetEl: t, planeEl: p, videoEl: v }]) => {
                if (otherName !== name) {
                  v.pause();
                  p.object3D.visible = false;
                }
              }
            );
            // show this plane and play
            targetEl.object3D.visible = true;
            planeEl.object3D.visible = true;
            currentlyPlayingId = name;
            videoEl.play().catch(() => {
              // If autoplay with sound is blocked, wait for a single user tap
              const onceClick = () => {
                videoEl.play().catch(() => {});
                document.removeEventListener("click", onceClick);
              };
              document.addEventListener("click", onceClick, { once: true });
            });
          });

          targetEl.addEventListener("targetLost", () => {
            if (targetLostTimers[name]) clearTimeout(targetLostTimers[name]);
            targetEl.object3D.visible = true; // keep visible during grace to avoid flicker
            targetLostTimers[name] = setTimeout(() => {
              videoEl.pause();
              targetEl.object3D.visible = false;
              planeEl.object3D.visible = false;
              if (currentlyPlayingId === name) currentlyPlayingId = null;
            }, LOST_GRACE_MS);
          });

          videoEl.addEventListener("ended", () => {
            if (currentlyPlayingId === name) {
              learnMoreBtn.style.display = "block";
            }
          });
        });

        learnMoreBtn.onclick = function () {
          window.location.href =
            "https://www.cityofdreamsmacau.com/tc/house-of-dancing-water";
        };
      });
    </script>
  </body>
</html>
